import numpy as np
chrs = np.arange(1, 23)
units = ["1kb", "genetic"]

rule all:
	input:
		expand("archaic_freqs/chr{chrom}_frq_{unit}_windows.txt", chrom = chrs, unit = units),
		#expand("homo_{unit}_windows.bed", unit=units),
		expand("gene_density_{unit}_windows.txt", unit = units),
		expand("wavelet_results/{result}.txt",result=["wv1kb","wvM","wc1kb_freq_rec","wcM_freq_rec","wc1kb_freq_gdr","wcM_freq_gdr","lm1kb","lmM"])

rule get_freq:
	input:
	output:
		"archaic_freqs/chr{chr}_frq_1kb_windows.txt",
		"archaic_freqs/chr{chr}_frq_genetic_windows.txt"
	shell:
		"""
		Rscript --vanilla archaic_freq_1chrom.R {wildcards.chr} \
				Neanderthal_files/41586_2020_2225_MOESM3_ESM.txt \
				recomb-hg38/genetic_map_GRCh38_merged.tab
		"""
rule make_window_beds:
	input:
	output:
		physical="homo_1kb_windows.bed", 
		genetic="homo_genetic_windows.bed"
	shell:
		"""
		Rscript --vanilla homo_make1kb_bed.R | sort -k1,1 -k2,2n > {output.physical}
		Rscript --vanilla homo_make_genetic_windows_bed.R | sort -k1,1 -k2,2n > {output.genetic}
		"""

rule gtf_to_bed:
	input:
		"hg38.knownGene.gtf"	
	output:
		"hg38.knownGene.bed"
	shell:
		"gtf2bed < {input} > {output}"

rule calculate_gene_density:
	input:
		A1="homo_1kb_windows.bed",
		A2="homo_genetic_windows.bed",
		B="hg38.knownGene.bed"
	output:
		out1="gene_density_1kb_windows.txt",
		out2="gene_density_genetic_windows.txt",
	shell:
		"""
		bedtools coverage -a {input.A1} -b {input.B} | cut -f1-3,7 |\
		sort -k1,1 -k2,2n > {output.out1}
	
		# for genetic windows kept Morgan for id so there's an extra col in output
		bedtools coverage -a {input.A2} -b {input.B} | cut -f1-4,8 |\
		sort -k1,1 -k2,2n > {output.out2}
		"""
	
rule run_wavelets:
	input:
		expand("gene_density_{unit}_windows.txt",unit=units),
		expand("archaic_freqs/chr{chr}_frq_{unit}_windows.txt",chr=chrs,unit=units)	
	output:
		expand("wavelet_results/{result}.txt",result=["wv1kb","wvM","wc1kb_freq_rec","wcM_freq_rec","wc1kb_freq_gdr","wcM_freq_gdr","lm1kb","lmM"])
	shell:
		"""
		Rscript --vanilla wavelet_analyses.R
		"""

import numpy as np
import os
years = ["2006","2008","2013","2015","2018"]
scaffs = [s.replace("LD_map_xbirchmanni-COAC-10x-","").replace(".post.txt_mod.bed","") for s in os.listdir("LD_recMap")]

rule all:
	input:
		expand("ACUA_{year}/varDecompAll.RData",year=years),
		expand("ACUA_{year}/rAncCorDecompAll.RData",year=years),
		expand("ACUA_{year}/avgFrq_totalCor.RData",year=years)

rule wrangle:
	input: 
		expand("ancestry-probs-par{par}_allchrs_ACUA_historical_{{year}}.tsv", par=["1","2"]),
		"LD_recMap/LD_map_xbirchmanni-COAC-10x-{scaff}.post.txt_mod.bed"
	output:
		"ACUA_{year}/{scaff}.RData"
	shell:
		"Rscript --vanilla swordtail_wrangle.R {wildcards.year} {wildcards.scaff}"

rule all_year_chr:
	input:
		expand("ACUA_{year}/{scaff}.RData",year=years,scaff=scaffs)

rule make_interp_interval_bed:
	input:
		"ancestry-probs-par1_allchrs_ACUA_historical_2018.tsv"
	output:
		"allChrs_1kb.bed"
	shell:
		"Rscript --vanilla chr_1kb_bed.R"

rule make_CDS_bed:
	input:
		"xiphophorus_birchmanni_10x_12Sep2018_yDAA6.gtf" 
	output:
		"Xbirch_CDS.bed"
	shell:
		"""
		grep 'CDS' {input} | cut -f1,4,5 | awk '{print $1 "\t" $2-1 "\t" $3}' |\\
		sort -k1,1 -k2,2n | bedtools merge -i stdin > {output}
		"""

rule avgFrq_totalCor:
	input:
		expand("ACUA_{{year}}/{scaff}.RData",scaff=scaffs)
	output:
		"ACUA_{year}/avgFrq_totalCor.RData"
	shell:
		"Rscript --vanilla avgFrq_totalCor.R {wildcards.year}"

rule combine_chrs_and_run_wavelets:
	input:
		expand("ACUA_{{year}}/{scaff}.RData",scaff=scaffs)
	output:
		"ACUA_{year}/varDecompAll.RData",
		"ACUA_{year}/rAncCorDecompAll.RData"
	shell:
		"Rscript --vanilla swordtail_wavelets.R {wildcards.year}"
